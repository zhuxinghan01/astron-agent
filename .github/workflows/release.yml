name: Release Multi-Language CI/CD Tools

on:
  push:
    tags:
      - 'v*.*.*'      # åŒ¹é…è¯­ä¹‰ç‰ˆæœ¬å· (v1.0.0, v2.1.3, etc.)
      - 'v*.*.*-*'    # åŒ¹é…é¢„å‘å¸ƒç‰ˆæœ¬ (v1.0.0-beta.1, v2.1.0-rc.1, etc.)
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write

env:
  REGISTRY_GHCR: ghcr.io

jobs:
  # ============================================================================
  # Stage 1: éªŒè¯å’Œå‡†å¤‡
  # ============================================================================
  prepare-release:
    name: ğŸš€ å‡†å¤‡å‘å¸ƒ
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      is-prerelease: ${{ steps.meta.outputs.is-prerelease }}
      has-go: ${{ steps.detect.outputs.has-go }}
      has-java: ${{ steps.detect.outputs.has-java }}
      has-python: ${{ steps.detect.outputs.has-python }}
      has-typescript: ${{ steps.detect.outputs.has-typescript }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç”Ÿæˆchangelog

      - name: éªŒè¯æ ‡ç­¾æ ¼å¼
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.tag }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
            # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ (åŒ…å« -, alpha, beta, rc ç­‰)
            if [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              IS_PRERELEASE="false"
            else
              IS_PRERELEASE="true"
            fi
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "âŒ é”™è¯¯çš„ç‰ˆæœ¬å·æ ¼å¼: $VERSION"
            echo "âœ… æ­£ç¡®æ ¼å¼: v1.0.0, v1.0.0-beta.1, v1.0.0-rc.1"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ å‘å¸ƒç‰ˆæœ¬: $VERSION"
          echo "ğŸ”– é¢„å‘å¸ƒç‰ˆæœ¬: $IS_PRERELEASE"

      - name: æ™ºèƒ½é¡¹ç›®æ£€æµ‹
        id: detect
        run: |
          echo "ğŸ” æ£€æµ‹é¡¹ç›®ç»„ä»¶..."
          
          HAS_GO="false"
          HAS_JAVA="false" 
          HAS_PYTHON="false"
          HAS_TS="false"
          
          if [[ -f "backend-go/go.mod" && -d "backend-go/cmd" && -f "backend-go/Dockerfile" ]]; then
            HAS_GO="true"
            echo "âœ… Goé¡¹ç›®: backend-go/ (å¯æ„å»ºDockeré•œåƒ)"
          fi
          
          if [[ -f "backend-java/pom.xml" && -f "backend-java/Dockerfile" ]]; then
            HAS_JAVA="true"
            echo "âœ… Javaé¡¹ç›®: backend-java/ (å¯æ„å»ºDockeré•œåƒ)"
          fi
          
          if [[ -f "backend-python/main.py" && -f "backend-python/requirements.txt" && -f "backend-python/Dockerfile" ]]; then
            HAS_PYTHON="true"
            echo "âœ… Pythoné¡¹ç›®: backend-python/ (å¯æ„å»ºDockeré•œåƒ)"
          fi
          
          if [[ -f "frontend-ts/package.json" && -f "frontend-ts/tsconfig.json" && -f "frontend-ts/Dockerfile" ]]; then
            HAS_TS="true"
            echo "âœ… TypeScripté¡¹ç›®: frontend-ts/ (å¯æ„å»ºDockeré•œåƒ)"
          fi
          
          echo "has-go=$HAS_GO" >> $GITHUB_OUTPUT
          echo "has-java=$HAS_JAVA" >> $GITHUB_OUTPUT
          echo "has-python=$HAS_PYTHON" >> $GITHUB_OUTPUT
          echo "has-typescript=$HAS_TS" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          echo "ğŸ“ ç”Ÿæˆå˜æ›´æ—¥å¿—..."
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="${{ steps.meta.outputs.version }}"
          
          if [[ -z "$PREVIOUS_TAG" ]]; then
            echo "ğŸ†• è¿™æ˜¯ç¬¬ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬"
            COMMIT_RANGE="HEAD"
          else
            echo "ğŸ“Š å¯¹æ¯”ç‰ˆæœ¬: $PREVIOUS_TAG...$CURRENT_TAG"
            COMMIT_RANGE="$PREVIOUS_TAG..HEAD"
          fi
          
          # åˆ›å»ºç®€å•çš„changelog
          CHANGELOG_FILE="/tmp/changelog.md"
          
          # å†™å…¥æ ‡é¢˜
          echo "## ğŸš€ ä¸»è¦å˜æ›´" > "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          
          # è·å–å¹¶åˆ†ç±»æäº¤
          echo "### âœ¨ æ–°åŠŸèƒ½" >> "$CHANGELOG_FILE"
          if git log --pretty=format:"%s" $COMMIT_RANGE | grep "^feat" | sed 's/^feat[^:]*: /- /' >> "$CHANGELOG_FILE"; then
            true
          else
            echo "- æš‚æ— æ–°åŠŸèƒ½" >> "$CHANGELOG_FILE"
          fi
          
          echo "" >> "$CHANGELOG_FILE"
          echo "### ğŸ› é—®é¢˜ä¿®å¤" >> "$CHANGELOG_FILE"
          if git log --pretty=format:"%s" $COMMIT_RANGE | grep "^fix" | sed 's/^fix[^:]*: /- /' >> "$CHANGELOG_FILE"; then
            true
          else
            echo "- æš‚æ— é—®é¢˜ä¿®å¤" >> "$CHANGELOG_FILE"
          fi
          
          echo "" >> "$CHANGELOG_FILE"
          echo "### ğŸ”§ å…¶ä»–æ”¹è¿›" >> "$CHANGELOG_FILE"
          if git log --pretty=format:"%s" $COMMIT_RANGE | grep -E "^(chore|docs|refactor|test|ci)" | sed 's/^[^:]*: /- /' >> "$CHANGELOG_FILE"; then
            true
          else
            echo "- æš‚æ— å…¶ä»–æ”¹è¿›" >> "$CHANGELOG_FILE"
          fi
          
          # æ·»åŠ Dockeré•œåƒä¿¡æ¯
          echo "" >> "$CHANGELOG_FILE"
          echo "## ğŸ“¦ Dockeré•œåƒ" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          
          if [[ "${{ steps.detect.outputs.has-go }}" == "true" ]]; then
            echo "- ğŸ¹ GoæœåŠ¡: ghcr.io/${{ github.repository }}-go:$CURRENT_TAG" >> "$CHANGELOG_FILE"
          fi
          if [[ "${{ steps.detect.outputs.has-java }}" == "true" ]]; then
            echo "- â˜• JavaæœåŠ¡: ghcr.io/${{ github.repository }}-java:$CURRENT_TAG" >> "$CHANGELOG_FILE"
          fi
          if [[ "${{ steps.detect.outputs.has-python }}" == "true" ]]; then
            echo "- ğŸ PythonæœåŠ¡: ghcr.io/${{ github.repository }}-python:$CURRENT_TAG" >> "$CHANGELOG_FILE"
          fi
          if [[ "${{ steps.detect.outputs.has-typescript }}" == "true" ]]; then
            echo "- ğŸŸ¦ TypeScriptå‰ç«¯: ghcr.io/${{ github.repository }}-frontend:$CURRENT_TAG" >> "$CHANGELOG_FILE"
          fi
          
          # æ·»åŠ ä½¿ç”¨è¯´æ˜  
          echo "" >> "$CHANGELOG_FILE"
          echo "## ğŸ“‹ ä½¿ç”¨è¯´æ˜" >> "$CHANGELOG_FILE"
          echo "" >> "$CHANGELOG_FILE"
          echo "### å¿«é€Ÿå¼€å§‹" >> "$CHANGELOG_FILE"
          echo '```bash' >> "$CHANGELOG_FILE"
          echo "git clone https://github.com/${{ github.repository }}.git" >> "$CHANGELOG_FILE"
          echo "cd remote-ci" >> "$CHANGELOG_FILE"
          echo "git checkout $CURRENT_TAG" >> "$CHANGELOG_FILE"
          echo "make setup  # åˆå§‹åŒ–ç¯å¢ƒ" >> "$CHANGELOG_FILE"
          echo "make ci     # å®Œæ•´CIæµç¨‹" >> "$CHANGELOG_FILE"
          echo '```' >> "$CHANGELOG_FILE"
          
          # è¾“å‡ºåˆ°GitHub Output
          {
            echo "changelog<<EOF"
            cat "$CHANGELOG_FILE"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "ğŸ“„ å˜æ›´æ—¥å¿—å·²ç”Ÿæˆ"

  # ============================================================================
  # Stage 2: æ„å»ºDockeré•œåƒ (å¤ç”¨build-pushçš„é€»è¾‘)
  # ============================================================================
  build-go:
    name: ğŸ¹ æ„å»ºGoæœåŠ¡
    runs-on: ubuntu-latest
    needs: prepare-release
    if: needs.prepare-release.outputs.has-go == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_GHCR }}/${{ github.repository }}-go
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=${{ needs.prepare-release.outputs.version }}

      - name: Build and push Go image
        uses: docker/build-push-action@v5
        with:
          context: backend-go
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.prepare-release.outputs.version }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.run_id }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-java:
    name: â˜• æ„å»ºJavaæœåŠ¡
    runs-on: ubuntu-latest
    needs: prepare-release
    if: needs.prepare-release.outputs.has-java == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_GHCR }}/${{ github.repository }}-java
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=${{ needs.prepare-release.outputs.version }}

      - name: Build and push Java image
        uses: docker/build-push-action@v5
        with:
          context: backend-java
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.prepare-release.outputs.version }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.run_id }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-python:
    name: ğŸ æ„å»ºPythonæœåŠ¡
    runs-on: ubuntu-latest
    needs: prepare-release
    if: needs.prepare-release.outputs.has-python == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_GHCR }}/${{ github.repository }}-python
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=${{ needs.prepare-release.outputs.version }}

      - name: Build and push Python image
        uses: docker/build-push-action@v5
        with:
          context: backend-python
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.prepare-release.outputs.version }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.run_id }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-typescript:
    name: ğŸŸ¦ æ„å»ºTypeScriptå‰ç«¯
    runs-on: ubuntu-latest
    needs: prepare-release
    if: needs.prepare-release.outputs.has-typescript == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY_GHCR }}/${{ github.repository }}-frontend
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=${{ needs.prepare-release.outputs.version }}

      - name: Build and push TypeScript image
        uses: docker/build-push-action@v5
        with:
          context: frontend-ts
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.prepare-release.outputs.version }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ github.run_id }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # Stage 3: ç”Ÿæˆå‘å¸ƒäº§ç‰©
  # ============================================================================
  create-artifacts:
    name: ğŸ“¦ ç”Ÿæˆå‘å¸ƒäº§ç‰©
    runs-on: ubuntu-latest
    needs: prepare-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…..."
          VERSION="${{ needs.prepare-release.outputs.version }}"
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release-artifacts
          
          # æ‰“åŒ…æºä»£ç  (æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶)
          echo "ğŸ“ æ‰“åŒ…æºä»£ç ..."
          tar -czf release-artifacts/remote-ci-${VERSION}-source.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='target' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            --exclude='release-artifacts' \
            .
          
          # æ‰“åŒ…Makefileå·¥å…·é“¾
          echo "ğŸ› ï¸ æ‰“åŒ…Makefileå·¥å…·é“¾..."
          tar -czf release-artifacts/remote-ci-${VERSION}-makefiles.tar.gz \
            Makefile \
            makefiles/ \
            README.md \
            Makefile-readme.md
          
          # ç”Ÿæˆå®‰è£…è„šæœ¬
          echo "ğŸ“ ç”Ÿæˆå®‰è£…è„šæœ¬..."
          cat > release-artifacts/install.sh << 'INSTALL_EOF'
          #!/bin/bash
          set -e
          
          VERSION="${{ needs.prepare-release.outputs.version }}"
          REPO="${{ github.repository }}"
          
          echo "ğŸš€ å®‰è£… Remote CI/CD å·¥å…·é“¾ $VERSION"
          echo ""
          
          # æ£€æŸ¥å¿…è¦å·¥å…·
          command -v git >/dev/null 2>&1 || { echo "âŒ Git æœªå®‰è£…"; exit 1; }
          command -v make >/dev/null 2>&1 || { echo "âŒ Make æœªå®‰è£…"; exit 1; }
          
          # ä¸‹è½½å¹¶è§£å‹
          echo "ğŸ“¥ ä¸‹è½½å·¥å…·é“¾..."
          curl -L "https://github.com/$REPO/releases/download/$VERSION/remote-ci-$VERSION-makefiles.tar.gz" | tar -xz
          
          echo "âœ… å®‰è£…å®Œæˆ!"
          echo ""
          echo "ğŸ¯ å¿«é€Ÿå¼€å§‹:"
          echo "  make setup    # åˆå§‹åŒ–ç¯å¢ƒ"
          echo "  make status   # æŸ¥çœ‹é¡¹ç›®çŠ¶æ€"
          echo "  make format   # æ ¼å¼åŒ–ä»£ç "
          echo "  make check    # è´¨é‡æ£€æŸ¥"
          echo "  make test     # è¿è¡Œæµ‹è¯•"
          echo "  make build    # æ„å»ºé¡¹ç›®"
          INSTALL_EOF
          
          chmod +x release-artifacts/install.sh
          
          # ç”Ÿæˆchecksums
          echo "ğŸ” ç”Ÿæˆæ ¡éªŒæ–‡ä»¶..."
          cd release-artifacts
          sha256sum *.tar.gz *.sh > checksums.txt
          
          echo "ğŸ“Š å‘å¸ƒäº§ç‰©åˆ—è¡¨:"
          ls -la

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: release-artifacts/
          retention-days: 90

  # ============================================================================
  # Stage 4: åˆ›å»ºGitHub Release
  # ============================================================================
  create-release:
    name: ğŸ‰ åˆ›å»ºGitHub Release
    runs-on: ubuntu-latest
    needs: 
      - prepare-release
      - build-go
      - build-java
      - build-python
      - build-typescript
      - create-artifacts
    if: always() && needs.prepare-release.result == 'success' && needs.create-artifacts.result == 'success'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare-release.outputs.version }}
          name: "Remote CI/CD å·¥å…·é“¾ ${{ needs.prepare-release.outputs.version }}"
          body: ${{ needs.prepare-release.outputs.changelog }}
          prerelease: ${{ needs.prepare-release.outputs.is-prerelease }}
          files: |
            ./artifacts/*
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒæ€»ç»“
        run: |
          echo "=== ğŸ‰ å‘å¸ƒæ€»ç»“ ==="
          echo ""
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ needs.prepare-release.outputs.version }}"
          echo "ğŸ”– é¢„å‘å¸ƒ: ${{ needs.prepare-release.outputs.is-prerelease }}"
          echo "ğŸ“¦ å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare-release.outputs.version }}"
          echo ""
          
          echo "ğŸ³ Dockeré•œåƒæ„å»ºçŠ¶æ€:"
          echo "  ğŸ¹ GoæœåŠ¡: ${{ needs.build-go.result }}"
          echo "  â˜• JavaæœåŠ¡: ${{ needs.build-java.result }}"
          echo "  ğŸ PythonæœåŠ¡: ${{ needs.build-python.result }}"
          echo "  ğŸŸ¦ TypeScriptå‰ç«¯: ${{ needs.build-typescript.result }}"
          echo ""
          
          echo "ğŸ“¦ å‘å¸ƒäº§ç‰©:"
          ls -la ./artifacts/
          echo ""
          
          echo "ğŸ¯ å¿«é€Ÿå®‰è£…:"
          echo "curl -sSL https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare-release.outputs.version }}/install.sh | bash"
          echo ""
          
          echo "âœ… ğŸš€ å‘å¸ƒå®Œæˆ!"